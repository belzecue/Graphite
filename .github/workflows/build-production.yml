name: "Editor: Production (Latest Stable)"

on:
  push:
    tags:
      - "latest-stable"

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
      deployments: write
    env:
      RUSTC_WRAPPER: /usr/bin/sccache
      CARGO_INCREMENTAL: 0
      SCCACHE_DIR: /var/lib/github-actions/.cache

    steps:
      - name: üì• Clone and checkout repository
        uses: actions/checkout@v3

      - name: üóë Clear wasm-bindgen cache
        run: rm -r ~/.cache/.wasm-pack

      - name: üü¢ Install the latest Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "latest"

      - name: üöß Install Node dependencies
        run: |
          cd frontend
          npm ci

      - name: ü¶Ä Install the latest Rust
        run: |
          echo "Initial system version:"
          rustc --version
          rustup update stable
          echo "Latest updated version:"
          rustc --version

      - name: ‚úÇ Replace template in <head> of index.html
        run: |
          # Check if we are on the locally-serve-fonts branch
          if git rev-parse --abbrev-ref HEAD | grep locally-serve-fonts > /dev/null; then
            export INDEX_HTML_HEAD_SCRIPT=$(curl -s https://graphite.rs/visit/script.hash.js) || exit 1
            export INDEX_HTML_HEAD_REPLACEMENT="<script data-domain=\"editor.graphite.rs\" data-api=\"https://graphite.rs/visit/event\">$INDEX_HTML_HEAD_SCRIPT</script>"
          else
            export INDEX_HTML_HEAD_REPLACEMENT=""
          fi
          sed -i "s|<!-- INDEX_HTML_HEAD_REPLACEMENT -->|$INDEX_HTML_HEAD_REPLACEMENT|" frontend/index.html
          echo "INDEX_HTML_HEAD_REPLACEMENT=$INDEX_HTML_HEAD_REPLACEMENT" >> $GITHUB_ENV

      - name: üåê Build Graphite web code
        env:
          NODE_ENV: production
        run: |
          cd frontend
          mold -run npm run build

      - name: üì§ Publish to Cloudflare Pages
        id: cloudflare
        uses: cloudflare/pages-action@1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          projectName: graphite-editor
          directory: frontend/dist
          branch: master

      - name: üì¶ Upload assets to GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(git log -1 --format=%cd --date=format:%Y-%m-%d)
          cd frontend
          sed -i "s|$INDEX_HTML_HEAD_REPLACEMENT||" dist/index.html
          mv dist "graphite-$DATE"
          zip -r "graphite-self-hosted-build.zip" "graphite-$DATE"
          gh release upload latest-stable "graphite-self-hosted-build.zip" --clobber
